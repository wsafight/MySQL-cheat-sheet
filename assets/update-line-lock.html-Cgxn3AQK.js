import{_ as a,c as n,b as s,o as i}from"./app--XYqrjBE.js";const l={};function t(d,e){return i(),n("div",null,e[0]||(e[0]=[s('<h1 id="使用数据库更新行级锁处理并发问题" tabindex="-1"><a class="header-anchor" href="#使用数据库更新行级锁处理并发问题"><span>使用数据库更新行级锁处理并发问题</span></a></h1><p>如果当前 MySQL 中事务的隔离界别是 RC 或者更高级别，会使用行级锁来处理对应 UPDATE 操作。</p><p>对比以下两个代码操作：</p><div class="language-SQL line-numbers-mode" data-highlighter="prismjs" data-ext="SQL" data-title="SQL"><pre><code><span class="line">SELECT `quota` FROM `table_name` WHERE `id` = &#39;xxx&#39;</span>\n<span class="line"></span>\n<span class="line">-- 添加判断 quota &gt;= 10 ，直接返回额度不足</span>\n<span class="line">-- 执行数据操作 newQuota = quota - 10</span>\n<span class="line"></span>\n<span class="line">UPDATE `table_name` SET `quota` = newQuota WHERE `id` = &#39;xxx&#39;</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-SQL line-numbers-mode" data-highlighter="prismjs" data-ext="SQL" data-title="SQL"><pre><code><span class="line">UPDATE `table_name` SET `quota` = `quota` - 10 WHERE `id` = &#39;xxx&#39; AND `quota` &gt;= 10</span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>如果当前用户量请求较少的情况下，上述两个代码都没有问题。但是如果用户量稍微大一点，第一个代码就会出现异常，由于多个请求同一时间都会获取到相同额度，减少额度后更新都是相同的数据。从而导致实际的额度远远小于数据库额度。</p><p>第二个代码不会出现上述问题，由于行级锁的存在，UPDATE 语句只能串行执行。</p><p>注：当前也可以使用乐观锁（注意业务）和分布式锁来处理，但不要使用对应编程语言或操作系统的锁机制处理，因为对应处理只会对单机系统有效。</p>',8)]))}const c=a(l,[["render",t],["__file","update-line-lock.html.vue"]]),p=JSON.parse('{"path":"/mysql/notes/update-line-lock.html","title":"使用数据库更新行级锁处理并发问题","lang":"zh-CN","frontmatter":{},"headers":[],"git":{"updatedTime":1702177967000,"contributors":[{"name":"wsafight","email":"984292420@qq.com","commits":2}]},"filePathRelative":"mysql/notes/update-line-lock.md"}');export{c as comp,p as data};
