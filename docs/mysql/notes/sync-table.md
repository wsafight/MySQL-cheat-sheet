# 迁移表同步问题分析

云数据库基本上都会提供数据表迁移的功能。以方便用户迁移。

在迁移数据表的过程中，对应工具会先进行全量复制，在全量复制完成后会继续根据原表的 binlog 对新表进行增量修改。时间往往仅差 1 ～ 2s。如果当前业务针对数据的实时性的要求不是那么高（日志类数据），查询接口可以直接替换到新表（新库）。

针对数据修改接口则并非那么简单。如果线上服务有多个 Pod。直接发布 Pod 时，有可能会丢失信息，这是因为在主键自增的情况下。增量复制和线上服务插入会导致 id 重复。那么就有可能出现数据在新表插入失败。

由于用户在更改源数据表时肯定会成功的，但在数据表迁移过程中可能会丢失该条数据，用户在此基础上进行一系列操作都会出问题（例如用户会去更新新数据表，而新数据表中 id 对应的数据并非插入的那一条）。

针对这种情况，开发者该如何处理呢？开发者在建立新库时不用 id 作为主键，而是使用 id + 操作者 id 作为新表的主键。这样就大大减少了主键冲突的可能。同一时刻同一个操作者同时操作两条数据是不大可能的。在等到线上 Pod 发布完成后，开发者再进行一次数据整理然后把主键改回 id 即可。

当然了，迁移写入前建议用户更新或者查询建议都使用用 id + 操作者id 进行处理，这样就不会出现上述问题。
